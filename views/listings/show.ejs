<% layout("layouts/boilerplate") %>

<style>
  .show-wrapper {
    width: 70%;
    margin: 30px auto;
    font-family: 'Poppins', sans-serif;
  }

  .show-img-main {
    width: 100%;
    height: 420px;
    object-fit: cover;
    border-radius: 18px;
  }

  .info-box {
    background: #fff;
    padding: 25px;
    border-radius: 18px;
    margin-top: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  }

  .label-title {
    font-weight: 600;
    color: #333;
  }

  .value-text {
    color: #555;
    margin-bottom: 10px;
  }

  /* Login Prompt */
  .login-box {
    background: #fff3f4;
    padding: 20px;
    border-radius: 15px;
    text-align: center;
    margin-top: 25px;
    box-shadow: 0 3px 12px rgba(255, 56, 92, 0.25);
  }

  .login-btn-large {
    margin-top: 10px;
    background-color: #ff385c;
    border: none;
    padding: 12px 35px;
    border-radius: 50px;
    color: #fff;
    font-weight: 600;
    transition: 0.3s;
  }

  .login-btn-large:hover {
    background-color: #e23153;
    transform: scale(1.03);
  }

  /* Owner Buttons */
  .owner-actions {
    margin-top: 20px;
    display: flex;
    gap: 15px;
  }

  .owner-actions form,
  .owner-actions a {
    width: 160px;
  }

  /* Review Cards Grid */
  .reviews-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 18px;
    margin-top: 20px;
  }

  .review-card {
    background: #fff;
    padding: 18px;
    border-radius: 14px;
    box-shadow: 0 3px 12px rgba(0,0,0,0.05);
    transition: transform .2s ease;
  }

  .review-card:hover {
    transform: translateY(-4px);
  }

  .review-user {
    font-weight: 600;
    color: #222;
    font-size: 1rem;
  }

  .review-text {
    font-size: 0.95rem;
    color: #555;
    margin: 8px 0;
  }
</style>


<div class="show-wrapper">

  <h2><%= listing.title %></h2>

  <!-- IMAGE -->
  <img src="<%= listing.image.url %>" class="show-img-main" />

  <!-- DETAILS -->
  <div class="info-box">
    <p class="value-text"><span class="label-title">Hosted By: </span> @<%= listing.owner.username %></p>
    <p class="value-text"><span class="label-title">Description: </span> <%= listing.description %></p>
    <p class="value-text"><span class="label-title">Cost: </span> ₹ <%= listing.price.toLocaleString("en-IN") %></p>
    <p class="value-text"><span class="label-title">Location: </span> <%= listing.location %></p>
    <p class="value-text"><span class="label-title">Country: </span> <%= listing.country %></p>
  </div>


  <!-- EDIT / DELETE BUTTONS IF OWNER -->
  <% if(currUser && listing.owner._id.equals(currUser._id)) { %>
    <div class="owner-actions">
      <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark">Edit Listing</a>

      <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE">
        <button class="btn btn-danger">Delete Listing</button>
      </form>
    </div>
  <% } %>


  <!-- LOGIN BOX IF USER IS NOT LOGGED IN -->
  <% if(!currUser) { %>
  <div class="login-box">
      <h5><b>To access all features (Reviews, Post Review, Edit, Delete)</b></h5>
      <p>Please login to continue</p>
      <a href="/login" class="login-btn-large">Login</a>
  </div>
  <% } %>


  <!-- REVIEW FORM FOR LOGGED-IN USERS -->
  <% if(currUser) { %>
  <div class="info-box mt-4">
      <h4>Leave a Review</h4>

      <form action="/listings/<%= listing.id %>/reviews" method="POST">
        <label class="mt-2"><b>Rating</b></label>
        <select name="review[rating]" class="form-select mb-3">
          <option value="1">★ 1</option>
          <option value="2">★ 2</option>
          <option value="3">★ 3</option>
          <option value="4">★ 4</option>
          <option value="5">★ 5</option>
        </select>

        <label><b>Comment</b></label>
        <textarea class="form-control mb-3" rows="3" name="review[comment]" required></textarea>

        <button class="btn btn-dark">Submit</button>
      </form>
  </div>
  <% } %>


  <!-- ALL REVIEWS -->
  <% if(listing.reviews.length > 0) { %>
  <div class="info-box mt-4">
    <h4>All Reviews</h4>

    <div class="reviews-grid">

      <% listing.reviews.forEach(r => { %>
        <div class="review-card">

          <div class="review-user">@<%= r.author.username %></div>
          <p class="starability-result" data-rating="<%= r.rating %>"></p>

          <p class="review-text"><%= r.comment %></p>

          <% if(currUser && r.author.equals(currUser._id)) { %>
          <form method="POST" action="/listings/<%= listing._id %>/reviews/<%= r._id %>?_method=DELETE">
            <button class="btn btn-sm btn-danger mt-2">Delete</button>
          </form>
          <% } %>

        </div>
      <% }) %>

    </div>
  </div>
  <% } %>

</div>
